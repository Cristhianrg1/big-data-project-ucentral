<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de BigData</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/landingPage.css') }}" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h3 mb-0">Buscador en elastic</h2>
                <nav>
                    <ul class="nav">
                        <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/buscador"><b>Buscador</b></a></li>
                        <li class="nav-item"><a class="nav-link" href="/about">Acerca de</a></li>
                        <li class="nav-item"><a class="nav-link" href="/login">Ingresar</a></li>
                        <li class="nav-item"><a class="nav-link" href="/contacto"><b>Contacto</b></a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Buscador</h3>
                    </div>
                    <div class="card-body">
                        <form id="searchForm" method="POST" action="{{ url_for('buscador') }}">
                            <!-- Primera fila -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="search_type" class="form-label">Buscar en:</label>
                                    <select class="form-select" id="search_type" name="search_type" required>
                                        <option value="texto">Texto</option>
                                        <option value="titulo">titulo</option>
                                        <option value="autor">Autor</option>
                                        <option value="categoria">Categoría</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="fecha" class="form-label">Fecha desde:</label>
                                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde">
                                </div>
                                <div class="col-md-4">
                                    <label for="fecha_hasta" class="form-label">Fecha hasta:</label>
                                    <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta">
                                </div>
                            </div>

                            <!-- Segunda fila -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="search_text" class="form-label">Texto a buscar:</label>
                                    <input type="text" class="form-control" id="search_text" name="search_text" required>
                                </div>
                            </div>

                            <!-- Tercera fila -->
                            <div class="row">
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">Nueva búsqueda</button>
                                    <button type="submit" class="btn btn-primary">Buscar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center mt-4" id="div_resultado_busquedas">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5>Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div id="filtrosAccordion">
                            <!-- Los acordeones de filtros se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5>Resultados</h5>
                    </div>
                    <div class="card-body">
                        <table id="resultadosTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Autor</th>
                                    <th>Categoría</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los resultados se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        function limpiarFormulario() {
            document.getElementById('searchForm').reset();
            $('#resultadosTable').DataTable().clear().draw();
            $('#filtrosAccordion').empty();
        }

        // Validar que la fecha desde no sea mayor que la fecha hasta
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fechaDesde = document.getElementById('fecha_desde').value;
            const fechaHasta = document.getElementById('fecha_hasta').value;
            
            if (fechaDesde && fechaHasta && fechaDesde > fechaHasta) {
                alert('La fecha "desde" no puede ser mayor que la fecha "hasta"');
                return;
            }

            const searchType = document.getElementById('search_type').value;
            const searchText = document.getElementById('search_text').value;

            let query = {
                "query": {
                    "bool": {
                        "must": []
                    }
                },
                "aggs": {
                    "categoria": {
                        "terms": {
                            "field": "categoria",
                            "size": 10,
                            "order": { "_key": "asc" }
                        }
                    },
                    "clasificacion": {
                        "terms": {
                            "field": "clasificacion",
                            "size": 10,
                            "order": { "_key": "asc" }
                        }
                    },
                    "Fecha": {
                        "date_histogram": {
                            "field": "fecha",
                            "calendar_interval": "year",
                            "format": "yyyy"
                        }
                    }
                }
            };

            // Agregar condición de búsqueda según el tipo
            if (searchType === 'texto') {
                query.query.bool.must.push(
                    { "match": { "texto": searchText } },
                    {
                        "match_phrase": {
                            "texto": {
                                "query": searchText,
                                "slop": 3
                            }
                        }
                    }
                );
            } else {
                query.query.bool.must.push(
                    { "match": { [searchType]: searchText } }
                );
            }

            // Agregar rango de fechas si están presentes
            if (fechaDesde || fechaHasta) {
                const rangeQuery = {
                    "range": {
                        "prov_f_fecha": {
                            "format": "yyyy-MM-dd"
                        }
                    }
                };
                if (fechaDesde) rangeQuery.range.prov_f_fecha.gte = fechaDesde;
                if (fechaHasta) rangeQuery.range.prov_f_fecha.lte = fechaHasta;
                query.query.bool.must.push(rangeQuery);
            }

            // Realizar la búsqueda
            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    index: 'ucentral_test',
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                // Actualizar la tabla de resultados
                const table = $('#resultadosTable').DataTable();
                table.clear();
                
                data.hits.hits.forEach(hit => {
                    table.row.add([
                        hit._source.titulo || '',
                        hit._source.autor || '',
                        hit._source.categoria || '',
                        hit._source.fecha || ''
                    ]);
                });
                table.draw();

                // Actualizar los filtros
                updateFilters(data.aggregations);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al realizar la búsqueda');
            });
        });

        function updateFilters(aggregations) {
            const accordionContainer = $('#filtrosAccordion');
            accordionContainer.empty();

            // Crear acordeón para cada agregación
            Object.entries(aggregations).forEach(([aggName, aggData]) => {
                const accordionId = `accordion${aggName}`;
                const accordionHtml = `
                    <div class="accordion mb-3" id="${accordionId}">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${aggName}">
                                    ${aggName.charAt(0).toUpperCase() + aggName.slice(1)}
                                </button>
                            </h2>
                            <div id="collapse${aggName}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                                <div class="accordion-body">
                                    ${createAggregationItems(aggData, aggName)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                accordionContainer.append(accordionHtml);
            });
        }

        function createAggregationItems(aggData, aggName) {
            if (aggName === 'Fecha') {
                return aggData.buckets.map(bucket => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${bucket.key}" id="${aggName}_${bucket.key}">
                        <label class="form-check-label" for="${aggName}_${bucket.key}">
                            ${bucket.key} (${bucket.doc_count})
                        </label>
                    </div>
                `).join('');
            } else {
                return aggData.buckets.map(bucket => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${bucket.key}" id="${aggName}_${bucket.key}">
                        <label class="form-check-label" for="${aggName}_${bucket.key}">
                            ${bucket.key} (${bucket.doc_count})
                        </label>
                    </div>
                `).join('');
            }
        }

        // Inicializar DataTable
        $(document).ready(function() {
            $('#resultadosTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                },
                pageLength: 10,
                order: [[3, 'desc']]
            });
        });
    </script>
</body>
</html> 