{% extends "base_public.html" %}

{% block title %}Buscador - BigData-MiProyecto{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    .alert-service-unavailable {
        max-width: 800px;
        margin: 2rem auto;
    }
    .service-unavailable-icon {
        font-size: 4rem;
        color: #dc3545;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">Buscador de Documentos</h1>
    
    {% if not elasticsearch_available %}
    <div class="alert alert-warning alert-service-unavailable text-center">
        <div class="service-unavailable-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h3>Servicio de búsqueda no disponible</h3>
        <p class="mb-0">
            El servicio de búsqueda no está disponible en este momento. Estamos trabajando para solucionar el problema.
            Por favor, intente nuevamente más tarde o póngase en contacto con el administrador del sistema.
        </p>
    </div>
    {% endif %}

    <div class="container mt-4" {% if not elasticsearch_available %}style="display: none;"{% endif %}>
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Buscador</h3>
                    </div>
                    <div class="card-body">
                        <form id="searchForm" method="POST" action="{{ url_for('main.buscador') }}">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="query" class="form-label">Términos de búsqueda:</label>
                                    <input type="text" class="form-control" id="query" name="query" 
                                           value="{{ query }}" placeholder="Ingrese su búsqueda...">
                                    <div class="form-text">
                                        Buscará en títulos, contenido y autores. Use comillas para frases exactas.
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="fecha_desde" class="form-label">Fecha desde:</label>
                                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                                           value="{{ fecha_desde }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="fecha_hasta" class="form-label">Fecha hasta:</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta"
                                               value="{{ fecha_hasta }}">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tercera fila -->
                            <div class="row">
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">Nueva búsqueda</button>
                                    <button type="submit" class="btn btn-primary">Buscar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if error_message %}
        <div class="row justify-content-center mt-4">
            <div class="col-md-10">
                <div class="alert alert-danger" role="alert">
                    {{ error_message }}
                </div>
            </div>
        </div>
        {% endif %}

        {% if resultados %}
        <div class="row justify-content-center mt-4">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Resultados de la búsqueda</h5>
                        <span class="badge bg-primary">{{ resultados.hits.total.value }} resultados encontrados</span>
                    </div>
                    <div class="card-body">
                        {% for hit in resultados.hits.hits %}
                        <div class="card mb-3" id="doc-{{ hit._id }}">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="{{ url_for('main.ver_documento', document_id=hit._id) }}" class="text-decoration-none">
                                        {{ hit._source.titulo }}
                                    </a>
                                </h5>
                                <h6 class="card-subtitle mb-2 text-muted">
                                    <i class="bi bi-person-fill"></i> {{ hit._source.autor }}
                                    <span class="ms-3">
                                        <i class="bi bi-calendar3"></i> {{ hit._source.fecha_publicacion }}
                                    </span>
                                </h6>
                                {% if hit.highlight and hit.highlight.contenido %}
                                    <p class="card-text">
                                        {% for fragment in hit.highlight.contenido %}
                                            {{ fragment|safe }}...
                                        {% endfor %}
                                    </p>
                                {% else %}
                                    <p class="card-text">
                                        {{ hit._source.contenido|truncate(300) }}
                                    </p>
                                {% endif %}
                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                    <div>
                                        {% for etiqueta in hit._source.etiquetas %}
                                            <span class="badge bg-secondary me-1">{{ etiqueta }}</span>
                                        {% endfor %}
                                    </div>
                                    <a href="{{ url_for('main.ver_documento', document_id=hit._id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        Ver documento completo <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% elif query %}
        <div class="row justify-content-center mt-4">
            <div class="col-md-10">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    No se encontraron resultados para "{{ query }}". Intenta con otros términos de búsqueda.
                </div>
            </div>
        </div>
        {% endif %}
    </pre>

{% block extra_js %}
{% if elasticsearch_available %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
{% else %}
<!-- No cargar scripts de búsqueda si Elasticsearch no está disponible -->
{% endif %}

<script>
// Función para establecer fechas por defecto
function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    
    // Establecer la fecha actual como máximo para ambos campos
    document.getElementById('fecha_desde').max = today;
    document.getElementById('fecha_hasta').max = today;
    
    // Si no hay valor en fecha_hasta, establecer la fecha actual
    const fechaHasta = document.getElementById('fecha_hasta');
    if (!fechaHasta.value) {
        fechaHasta.value = today;
    }
    
    // Si no hay valor en fecha_desde, establecer el primer día del año actual
    const fechaDesde = document.getElementById('fecha_desde');
    if (!fechaDesde.value) {
        const defaultDate = new Date();
        defaultDate.setMonth(0, 1); // 1 de enero del año actual
        fechaDesde.value = defaultDate.toISOString().split('T')[0];
    }
    
    // Validar que la fecha desde no sea mayor a la fecha hasta
    if (fechaDesde.value > fechaHasta.value) {
        fechaHasta.value = fechaDesde.value;
    }
    
    // Añadir validación en tiempo real
    fechaDesde.addEventListener('change', function() {
        if (this.value > fechaHasta.value) {
            fechaHasta.value = this.value;
        }
    });
    
    fechaHasta.addEventListener('change', function() {
        if (this.value < fechaDesde.value) {
            fechaDesde.value = this.value;
        }
    });
}

// Función para limpiar el formulario
function limpiarFormulario() {
    document.getElementById('searchForm').reset();
    if ($.fn.DataTable.isDataTable('#resultadosTable')) {
        $('#resultadosTable').DataTable().destroy();
    }
    $('#div_resultado_busquedas').empty();
    setDefaultDate(); // Restablecer fechas por defecto al limpiar
}

// Cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Establecer fechas por defecto
    setDefaultDate();
    
    // Validar fechas al enviar el formulario
    document.getElementById('searchForm').addEventListener('submit', function(e) {
            const fechaDesde = document.getElementById('fecha_desde').value;
            const fechaHasta = document.getElementById('fecha_hasta').value;
            
            if (fechaDesde && fechaHasta && fechaDesde > fechaHasta) {
                e.preventDefault();
                alert('La fecha "desde" no puede ser mayor que la fecha "hasta"');
            }
        });

        // Inicializar DataTable si hay resultados
        $(document).ready(function() {
            if (document.getElementById('resultadosTable')) {
                $('#resultadosTable').DataTable({
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                    },
                    pageLength: 10,
                    order: [[3, 'desc']]
                });
            }
        });
    </script>
{% endblock %}
{% endblock %} 